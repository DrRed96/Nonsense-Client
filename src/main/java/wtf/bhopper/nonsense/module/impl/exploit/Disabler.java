package wtf.bhopper.nonsense.module.impl.exploit;

import net.minecraft.network.play.client.C03PacketPlayer;
import net.minecraft.network.play.server.S08PacketPlayerPosLook;
import wtf.bhopper.nonsense.event.EventLink;
import wtf.bhopper.nonsense.event.Listener;
import wtf.bhopper.nonsense.event.impl.packet.EventReceivePacket;
import wtf.bhopper.nonsense.event.impl.packet.EventSendPacket;
import wtf.bhopper.nonsense.module.AbstractModule;
import wtf.bhopper.nonsense.module.ModuleCategory;
import wtf.bhopper.nonsense.module.ModuleInfo;
import wtf.bhopper.nonsense.module.property.impl.EnumProperty;
import wtf.bhopper.nonsense.util.minecraft.player.PacketUtil;
import wtf.bhopper.nonsense.util.minecraft.player.PlayerUtil;

@ModuleInfo(name = "Disabler",
        description = "Bye bye bad anti-cheat!",
        category = ModuleCategory.EXPLOIT)
public class Disabler extends AbstractModule {

    private final EnumProperty<Mode> mode = new EnumProperty<>("Mode", "Disabler method", Mode.PACKET_FUCK);

    private Boolean lastReportedGround = null;

    public Disabler() {
        super();
        this.addProperties(this.mode);
        this.setSuffix(this.mode::getDisplayValue);
    }

    @Override
    public void onEnable() {
        this.lastReportedGround = null;
    }

    @EventLink
    public final Listener<EventSendPacket> onSend = event -> {
        switch (this.mode.get()) {
            case BALANCE -> {
                if (event.packet instanceof C03PacketPlayer packet) {
                    if (!packet.isMoving() && !packet.isRotating()) {
                        if (lastReportedGround == null) {
                            lastReportedGround = packet.isOnGround();
                        } else if (packet.isOnGround() == lastReportedGround) {
                            event.cancel();
                        }
                    }
                }
            }
        }
    };

    @EventLink
    public final Listener<EventReceivePacket> onReceivePacket = event -> {

        if (!PlayerUtil.canUpdate()) {
            return;
        }

        switch (this.mode.get()) {
            case FLAG -> {
                if (event.packet instanceof S08PacketPlayerPosLook packet) {
                    event.cancel();
                    PacketUtil.send(new C03PacketPlayer.C06PacketPlayerPosLook(packet.getX(), packet.getY(), packet.getZ(), packet.getYaw(), packet.getPitch(), false));
                }
            }

        }
    };

    public boolean packetFuck() {
        return this.isToggled() && this.mode.is(Mode.PACKET_FUCK);
    }

    private enum Mode {
        FLAG,
        WATCHDOG,
        BALANCE,
        PACKET_FUCK
    }


}
